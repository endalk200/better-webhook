name: Release CLI

on:
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  release-cli:
    name: Build and release CLI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: apps/webhook-cli/go.mod

      - name: Setup Devbox
        uses: ./.github/actions/setup-devbox

      - name: Configure npm registry auth
        uses: actions/setup-node@v4
        with:
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: devbox run -- just ci-install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN || secrets.NODE_AUTH_TOKEN }}

      - name: Format check
        run: devbox run -- just format-check

      - name: Lint
        run: devbox run -- just lint

      - name: Test
        run: devbox run -- just test

      - name: Build
        run: devbox run -- just build

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v7
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GORELEASER_CURRENT_TAG: ${{ github.ref_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Locate Homebrew tap PR
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          RELEASE_TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          title="chore: update better-webhook cask to ${RELEASE_TAG}"
          query="map(select(.title == \"${title}\")) | sort_by(.number) | reverse | .[0]"

          pr_number=$(gh pr list \
            --repo endalk200/homebrew-tap \
            --state all \
            --search "${title} in:title" \
            --json number,title \
            --jq "${query} | .number // empty")

          if [ -z "$pr_number" ]; then
            echo "Expected Homebrew tap PR not found for ${RELEASE_TAG}." >&2
            exit 1
          fi

          pr_url=$(gh pr view "$pr_number" --repo endalk200/homebrew-tap --json url --jq '.url')
          pr_state=$(gh pr view "$pr_number" --repo endalk200/homebrew-tap --json state --jq '.state')

          {
            echo "## Homebrew tap update"
            echo "- Tag: ${RELEASE_TAG}"
            echo "- PR: ${pr_url}"
            echo "- State: ${pr_state}"
          } >> "$GITHUB_STEP_SUMMARY"
