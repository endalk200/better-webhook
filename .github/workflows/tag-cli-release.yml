name: Tag CLI Release

on:
  push:
    branches: [main]
    paths:
      - "apps/webhook-cli/**"
      - ".github/workflows/release-cli.yml"
      - ".github/workflows/tag-cli-release.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  create-tag:
    name: Create next CLI semver tag
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute next tag
        id: version
        run: |
          set -euo pipefail

          latest_v_tag=$(git tag --list "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n1 || true)
          latest_legacy_tag=$(git tag --list "@better-webhook/cli@*" --sort=-v:refname | head -n1 || true)

          if [ -n "${latest_v_tag}" ]; then
            base_version="${latest_v_tag#v}"
          elif [ -n "${latest_legacy_tag}" ]; then
            base_version="${latest_legacy_tag#@better-webhook/cli@}"
          else
            base_version="0.0.0"
          fi

          IFS='.' read -r major minor patch <<<"${base_version}"
          commit_message="$(git log -1 --pretty=%B)"

          # Bump strategy:
          # - default: patch
          # - use "#minor" or "#major" in commit message to override
          if echo "${commit_message}" | grep -q "#major"; then
            major=$((major + 1))
            minor=0
            patch=0
          elif echo "${commit_message}" | grep -q "#minor"; then
            minor=$((minor + 1))
            patch=0
          else
            patch=$((patch + 1))
          fi

          next_tag="v${major}.${minor}.${patch}"

          if git rev-parse --verify "refs/tags/${next_tag}" >/dev/null 2>&1; then
            echo "Tag ${next_tag} already exists."
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "tag=${next_tag}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "tag_exists=false" >> "$GITHUB_OUTPUT"
          echo "tag=${next_tag}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        if: steps.version.outputs.tag_exists == 'false'
        run: |
          set -euo pipefail
          git tag "${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"
