name: Release CLI NPM Wrapper

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      tag:
        description: "CLI release tag to publish (for example: v1.2.3)"
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.release.tag_name || inputs.tag }}
  cancel-in-progress: false

jobs:
  smoke-test:
    name: Smoke test npm wrapper (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    if: ${{ github.event_name != 'release' || startsWith(github.event.release.tag_name, 'v') }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Resolve release tag
        env:
          INPUT_TAG: ${{ inputs.tag }}
          EVENT_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          TAG="${EVENT_TAG:-$INPUT_TAG}"
          if [ -z "$TAG" ]; then
            echo "Unable to resolve release tag."
            exit 1
          fi
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid release tag '$TAG'."
            exit 1
          fi
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p dist/cli-release-assets
          gh release download "$RELEASE_TAG" \
            --repo "${{ github.repository }}" \
            --pattern "better-webhook-*" \
            --pattern "checksums.txt" \
            --dir dist/cli-release-assets \
            --clobber

      - name: Verify checksums
        run: node scripts/cli-release/verify-release-checksums.mjs

      - name: Build npm bundles
        run: node scripts/cli-release/build-npm-bundles.mjs

      - name: Smoke test wrapper
        run: node scripts/cli-release/smoke-test-wrapper.mjs

  publish:
    name: Publish CLI npm packages
    runs-on: ubuntu-latest
    needs: smoke-test
    if: ${{ github.event_name != 'release' || startsWith(github.event.release.tag_name, 'v') }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Resolve release tag
        env:
          INPUT_TAG: ${{ inputs.tag }}
          EVENT_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          TAG="${EVENT_TAG:-$INPUT_TAG}"
          if [ -z "$TAG" ]; then
            echo "Unable to resolve release tag."
            exit 1
          fi
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "Invalid release tag '$TAG'."
            exit 1
          fi
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"

          DIST_TAG="latest"
          if [[ "$TAG" == *-* ]]; then
            DIST_TAG="next"
          fi
          echo "NPM_DIST_TAG=$DIST_TAG" >> "$GITHUB_ENV"

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p dist/cli-release-assets
          gh release download "$RELEASE_TAG" \
            --repo "${{ github.repository }}" \
            --pattern "better-webhook-*" \
            --pattern "checksums.txt" \
            --dir dist/cli-release-assets \
            --clobber

      - name: Verify checksums
        run: node scripts/cli-release/verify-release-checksums.mjs

      - name: Build npm bundles
        run: node scripts/cli-release/build-npm-bundles.mjs

      - name: Publish npm packages
        run: node scripts/cli-release/publish-npm-bundles.mjs
